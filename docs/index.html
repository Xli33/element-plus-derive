<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>element-plus-derive</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus@2.13.1/dist/index.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/element-plus@2.13.1/theme-chalk/dark/css-vars.css" />
    <link
      id="markdown-css"
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/github-markdown-css@5.8.1/github-markdown.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3.5.26/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-router@4.6.4/dist/vue-router.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus@2.13.1/dist/index.full.min.js"></script>
    <style>
      /* html.dark {
        .shiki,
        .shiki span {
          color: var(--shiki-dark) !important;
          background-color: var(--shiki-dark-bg) !important;
        }
      } */
      body {
        margin: 0;
        font-family:
          'Microsoft YaHei', 'å¾®è½¯é›…é»‘', 'PingFang SC', ' Hiragino Sans GB', 'SimSun', 'sans-serif';
        -webkit-tap-highlight-color: transparent;
      }

      #app {
        height: 100vh;
        margin: 0;
      }

      ul {
        list-style: none;
        padding-left: 0;
      }

      [v-cloak] {
        display: none;
      }

      .el-container {
        height: 100%;

        &::after {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100%;
          visibility: hidden;
          background-color: rgba(0, 0, 0, 0);
          transition:
            visibility 0.3s ease-out,
            background-color 0.3s ease-out;
        }

        &.show {
          .el-aside {
            box-shadow: 1px 0 10px rgba(0, 0, 0, 0.2);
            transform: translateX(0);
          }

          &::after {
            visibility: visible;
            background-color: rgba(0, 0, 0, 0.2);
          }
        }
      }

      .el-aside {
        position: fixed;
        z-index: 1;
        height: 100%;
        padding: 2vh 0;
        transform: translateX(-100%);
        background: var(--el-bg-color);
        transition: transform 0.3s ease-out;
      }

      .el-menu {
        border-right: none;
      }

      .markdown-body {
        display: flex;
        flex-direction: column;
      }

      @media screen and (min-width: 1200px) {
        #app {
          margin: 0 10vw;
        }
        .el-aside {
          transform: translateX(0);
        }
        .el-main {
          margin-left: 200px;
        }
        .menu-toggle {
          display: none;
        }
      }
    </style>
    <script>
      const matchDark = window.matchMedia('(prefers-color-scheme: dark)')
      matchDark.addEventListener('change', (e) => {
        const $markdownCss = document.getElementById('markdown-css')
        if (e.target.matches) {
          $markdownCss.href = $markdownCss.href.replace(
            'github-markdown.min.css',
            'github-markdown-dark.min.css'
          )
        } else {
          $markdownCss.href = $markdownCss.href.replace(
            'github-markdown-dark.min.css',
            'github-markdown.min.css'
          )
        }
        document.documentElement.classList.toggle('dark', e.target.matches)
      })
      matchDark.dispatchEvent(new Event('change'))
    </script>
  </head>

  <body>
    <div id="app" v-cloak>
      <el-container :class="showMenu && 'show'">
        <el-aside width="200px">
          <el-scrollbar>
            <el-menu v-if="menus.length" :default-active="activeMenu" :default-openeds="autoOpends">
              <template v-for="(item, index) in menus" :key="index">
                <!-- ä¸€çº§èœå• -->
                <el-menu-item v-if="!item.sub" :index="item.route || item.name" @click="open(item)">
                  {{ item.name }}
                </el-menu-item>
                <el-sub-menu v-else :index="item.name">
                  <!-- äºŒçº§èœå• -->
                  <template #title>
                    <span>{{ item.name }}</span>
                  </template>
                  <template v-for="(subMenu, subMenuIndex) in item.sub" :key="subMenuIndex">
                    <el-menu-item v-if="!subMenu.sub" :index="subMenu.name" @click="open(subMenu)">
                      {{ subMenu.name }}
                    </el-menu-item>

                    <!-- ä¸‰çº§èœå• -->
                    <el-sub-menu v-else :index="subMenu.name">
                      <template #title>
                        <span>{{ subMenu.name }}</span>
                      </template>
                      <el-menu-item
                        v-for="(thirdMenu, thirdMenuIndex) in subMenu.sub"
                        :key="thirdMenuIndex"
                        :index="thirdMenu.name"
                        @click="open(thirdMenu)">
                        {{ thirdMenu.name }}
                      </el-menu-item>
                    </el-sub-menu>
                  </template>
                </el-sub-menu>
              </template>
            </el-menu>
          </el-scrollbar>
        </el-aside>
        <el-main class="markdown-body">
          <el-icon class="menu-toggle" @click="showMenu = !showMenu">ðŸ““</el-icon>
          <el-scrollbar>
            <router-view v-slot="{ Component, route }">
              <keep-alive>
                <component
                  v-if="route.name"
                  :is="Component"
                  :key="route.name"
                  :content="route.meta.content"></component>
              </keep-alive>
            </router-view>
          </el-scrollbar>
        </el-main>
      </el-container>
    </div>

    <script>
      const contentCache = {}
      const { createApp, onMounted, ref, shallowRef, computed } = Vue
      const app = createApp({
        setup() {
          const menus = shallowRef([]),
            autoOpends = []
          const ViewMD = {
            template: `<div v-once v-html='content' class='md-content'></div>`,
            // props: {
            //   content: String
            // },
            setup(props) {
              // onMounted(() => {
              //   // document
              //   //   .getElementById('app')
              //   //   .querySelectorAll('.md-content pre code')
              //   //   .forEach((block) => {
              //   //     hljs.highlightElement(block)
              //   //   })
              // })
              const content = contentCache[route.name]
              if (content) {
                delete contentCache[route.name]
              }
              return {
                content
              }
            }
          }
          const route = VueRouter.useRoute()
          const activeMenu = computed(() => route.name)
          const showMenu = ref(false)

          const open = (e) => {
            if (e.name === router.currentRoute.value.name) return
            // console.log(e);
            router.replace({
              name: e.route || e.name
            })
          }

          onMounted(async () => {
            const res = await fetch('menus.json').then((res) => res.json())
            menus.value = res

            const recursiveAddRoute = (menus) => {
              menus.forEach((e, i) => {
                if (!e.sub) {
                  router.addRoute({
                    name: e.route || e.name,
                    path: '/' + (e.route || e.url.replace(/\.txt$/, '')),
                    meta: {
                      url: e.url
                    },
                    component: ViewMD
                  })
                  return
                }
                autoOpends.push(e.name)
                recursiveAddRoute(e.sub)
              })
            }
            recursiveAddRoute(menus.value)
            router.addRoute({
              path: '/',
              redirect: { name: 'start' }
            })
            loadingRoutes = null
            router.replace(route.fullPath)
            console.log(menus, autoOpends, router.getRoutes(), route)

            document.querySelector('.el-container').onclick = (e) => {
              if (
                showMenu.value &&
                !e.target.classList.contains('menu-toggle') &&
                !e.target.closest('.el-sub-menu__title')
              ) {
                showMenu.value = false
              }
            }
          })

          return {
            showMenu,
            activeMenu,
            menus,
            autoOpends,
            open
          }
        }
      })
      const router = VueRouter.createRouter({
        history: VueRouter.createWebHashHistory(),
        routes: []
      })
      let loadingRoutes = true
      router.beforeEach(async (to, from) => {
        // console.log(to, from);
        const toRoute = to.matched[to.matched.length - 1]
        // å½“æœªèŽ·å–åˆ°è·¯ç”±é…ç½®æ—¶å…è®¸è·³è½¬ä¸å­˜åœ¨çš„åœ°å€ï¼Œä»¥å…å§‹ç»ˆä¼šé‡å®šå‘åˆ° /startã€‚å½“è·¯ç”±é…ç½®åŠ è½½åŽä¼šé€šè¿‡ replace å°è¯•å¯¼èˆªåˆ°å­˜åœ¨çš„è·¯ç”±
        if (to.fullPath !== '/' && !toRoute) return loadingRoutes
        // è‹¥åŠ è½½è¿‡å¯¹åº”txtåˆ™ä¸é‡å¤èŽ·å–
        if (!toRoute || toRoute.meta.loaded) return
        try {
          const res = await fetch('readme/' + to.meta.url).then((res) => res.text())
          // to.meta.content = toRoute.meta.content = res
          contentCache[to.name] = res
          to.meta.loaded = toRoute.meta.loaded = true
        } catch (err) {
          console.error(err)
        }
      })
      router.afterEach((to) => {
        // activeMenu.value = to.name;
      })
      app.use(router)
      app.use(ElementPlus)
      app.mount('#app')
    </script>
  </body>
</html>
